import streamlit as st
import re
import plotly.graph_objects as go
from dataclasses import dataclass

# --- 1. åŸºç¤è³‡æ–™å®šç¾© ---
BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']

ELEMENTS_MAP = {
    'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´',
    'å¯…': 'æœ¨', 'å¯': 'æœ¨', 'å·³': 'ç«', 'åˆ': 'ç«', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'äº¥': 'æ°´', 'å­': 'æ°´', 'è¾°': 'åœŸ', 'æˆŒ': 'åœŸ', 'ä¸‘': 'åœŸ', 'æœª': 'åœŸ'
}

HIDDEN_STEMS_DATA = {
    'å­': [('ç™¸', 100)], 'ä¸‘': [('å·±', 60), ('ç™¸', 30), ('è¾›', 10)],
    'å¯…': [('ç”²', 60), ('ä¸™', 30), ('æˆŠ', 10)], 'å¯': [('ä¹™', 100)],
    'è¾°': [('æˆŠ', 60), ('ä¹™', 30), ('ç™¸', 10)], 'å·³': [('ä¸™', 60), ('åºš', 30), ('æˆŠ', 10)],
    'åˆ': [('ä¸', 70), ('å·±', 30)], 'æœª': [('å·±', 60), ('ä¸', 30), ('ä¹™', 10)],
    'ç”³': [('åºš', 60), ('å£¬', 30), ('æˆŠ', 10)], 'é…‰': [('è¾›', 100)],
    'æˆŒ': [('æˆŠ', 60), ('è¾›', 30), ('ä¸', 10)], 'äº¥': [('å£¬', 70), ('ç”²', 30)]
}

LIFE_STAGES = {
    'ç”²': {'äº¥': 'é•·ç”Ÿ', 'å­': 'æ²æµ´', 'ä¸‘': 'å† å¸¶', 'å¯…': 'è‡¨å®˜', 'å¯': 'å¸æ—º', 'è¾°': 'è¡°', 'å·³': 'ç—…', 'åˆ': 'æ­»', 'æœª': 'å¢“', 'ç”³': 'çµ•', 'é…‰': 'èƒ', 'æˆŒ': 'é¤Š'},
    'ä¹™': {'åˆ': 'é•·ç”Ÿ', 'å·³': 'æ²æµ´', 'è¾°': 'å† å¸¶', 'å¯': 'è‡¨å®˜', 'å¯…': 'å¸æ—º', 'ä¸‘': 'è¡°', 'å­': 'ç—…', 'äº¥': 'æ­»', 'æˆŒ': 'å¢“', 'é…‰': 'çµ•', 'ç”³': 'èƒ', 'æœª': 'é¤Š'},
    'ä¸™': {'å¯…': 'é•·ç”Ÿ', 'å¯': 'æ²æµ´', 'è¾°': 'å† å¸¶', 'å·³': 'è‡¨å®˜', 'åˆ': 'å¸æ—º', 'æœª': 'è¡°', 'ç”³': 'ç—…', 'é…‰': 'æ­»', 'æˆŒ': 'å¢“', 'äº¥': 'çµ•', 'å­': 'èƒ', 'ä¸‘': 'é¤Š'},
    'ä¸': {'é…‰': 'é•·ç”Ÿ', 'ç”³': 'æ²æµ´', 'æœª': 'å† å¸¶', 'åˆ': 'è‡¨å®˜', 'å·³': 'å¸æ—º', 'è¾°': 'è¡°', 'å¯': 'ç—…', 'å¯…': 'æ­»', 'ä¸‘': 'å¢“', 'å­': 'çµ•', 'äº¥': 'èƒ', 'æˆŒ': 'é¤Š'},
    'æˆŠ': {'å¯…': 'é•·ç”Ÿ', 'å¯': 'æ²æµ´', 'è¾°': 'å† å¸¶', 'å·³': 'è‡¨å®˜', 'åˆ': 'å¸æ—º', 'æœª': 'è¡°', 'ç”³': 'ç—…', 'é…‰': 'æ­»', 'æˆŒ': 'å¢“', 'äº¥': 'çµ•', 'å­': 'èƒ', 'ä¸‘': 'é¤Š'},
    'å·±': {'é…‰': 'é•·ç”Ÿ', 'ç”³': 'æ²æµ´', 'æœª': 'å† å¸¶', 'åˆ': 'è‡¨å®˜', 'å·³': 'å¸æ—º', 'è¾°': 'è¡°', 'å¯': 'ç—…', 'å¯…': 'æ­»', 'ä¸‘': 'å¢“', 'å­': 'çµ•', 'äº¥': 'èƒ', 'æˆŒ': 'é¤Š'},
    'åºš': {'å·³': 'é•·ç”Ÿ', 'åˆ': 'æ²æµ´', 'æœª': 'å† å¸¶', 'ç”³': 'è‡¨å®˜', 'é…‰': 'å¸æ—º', 'æˆŒ': 'è¡°', 'äº¥': 'ç—…', 'å­': 'æ­»', 'ä¸‘': 'å¢“', 'å¯…': 'çµ•', 'å¯': 'èƒ', 'è¾°': 'é¤Š'},
    'è¾›': {'å­': 'é•·ç”Ÿ', 'äº¥': 'æ²æµ´', 'æˆŒ': 'å† å¸¶', 'é…‰': 'è‡¨å®˜', 'ç”³': 'å¸æ—º', 'æœª': 'è¡°', 'åˆ': 'ç—…', 'å·³': 'æ­»', 'è¾°': 'å¢“', 'å¯': 'çµ•', 'å¯…': 'èƒ', 'ä¸‘': 'é¤Š'},
    'å£¬': {'ç”³': 'é•·ç”Ÿ', 'é…‰': 'æ²æµ´', 'æˆŒ': 'å† å¸¶', 'äº¥': 'è‡¨å®˜', 'å­': 'å¸æ—º', 'ä¸‘': 'è¡°', 'å¯…': 'ç—…', 'å¯': 'æ­»', 'è¾°': 'å¢“', 'å·³': 'çµ•', 'åˆ': 'èƒ', 'æœª': 'é¤Š'},
    'ç™¸': {'å¯': 'é•·ç”Ÿ', 'å¯…': 'æ²æµ´', 'ä¸‘': 'å† å¸¶', 'å­': 'è‡¨å®˜', 'äº¥': 'å¸æ—º', 'æˆŒ': 'è¡°', 'é…‰': 'ç—…', 'ç”³': 'æ­»', 'æœª': 'å¢“', 'åˆ': 'çµ•', 'å·³': 'èƒ', 'è¾°': 'é¤Š'}
}

NAYIN_DATA = {
    "ç”²å­": "æµ·ä¸­é‡‘", "ä¹™ä¸‘": "æµ·ä¸­é‡‘", "ä¸™å¯…": "çˆä¸­ç«", "ä¸å¯": "çˆä¸­ç«", "æˆŠè¾°": "å¤§æ—æœ¨", "å·±å·³": "å¤§æ—æœ¨",
    "åºšåˆ": "è·¯æ—åœŸ", "è¾›æœª": "è·¯æ—åœŸ", "å£¬ç”³": "åŠé‹’é‡‘", "ç™¸é…‰": "åŠé‹’é‡‘", "ç”²æˆŒ": "å±±é ­ç«", "ä¹™äº¥": "å±±é ­ç«",
    "ä¸™å­": "æ¾—ä¸‹æ°´", "ä¸ä¸‘": "æ¾—ä¸‹æ°´", "æˆŠå¯…": "åŸé ­åœŸ", "å·±å¯": "åŸé ­åœŸ", "åºšè¾°": "ç™½è Ÿé‡‘", "è¾›å·³": "ç™½è Ÿé‡‘",
    "å£¬åˆ": "æ¥ŠæŸ³æœ¨", "ç™¸æœª": "æ¥ŠæŸ³æœ¨", "ç”²ç”³": "æ³‰ä¸­æ°´", "ä¹™é…‰": "æ³‰ä¸­æ°´", "ä¸™æˆŒ": "å±‹ä¸ŠåœŸ", "ä¸äº¥": "å±‹ä¸ŠåœŸ",
    "æˆŠå­": "éœ¹é‚ç«", "å·±ä¸‘": "éœ¹é‚ç«", "åºšå¯…": "æ¾æŸæœ¨", "è¾›å¯": "æ¾æŸæœ¨", "å£¬è¾°": "é•·æµæ°´", "ç™¸å·³": "é•·æµæ°´",
    "ç”²åˆ": "ç ‚ä¸­é‡‘", "ä¹™æœª": "ç ‚ä¸­é‡‘", "ä¸™ç”³": "å±±ä¸‹ç«", "ä¸é…‰": "å±±ä¸‹ç«", "æˆŠæˆŒ": "å¹³åœ°æœ¨", "å·±äº¥": "å¹³åœ°æœ¨",
    "åºšå­": "å£ä¸ŠåœŸ", "è¾›ä¸‘": "å£ä¸ŠåœŸ", "å£¬å¯…": "é‡‘ç®”é‡‘", "ç™¸å¯": "é‡‘ç®”é‡‘", "ç”²è¾°": "ä½›ç‡ˆç«", "ä¹™å·³": "ä½›ç‡ˆç«",
    "ä¸™åˆ": "å¤©æ²³æ°´", "ä¸æœª": "å¤©æ²³æ°´", "æˆŠç”³": "å¤§é©›åœŸ", "å·±é…‰": "å¤§é©›åœŸ", "åºšæˆŒ": "é‡µé‡§é‡‘", "è¾›äº¥": "é‡µé‡§é‡‘",
    "å£¬å­": "æ¡‘æŸ˜æœ¨", "ç™¸ä¸‘": "æ¡‘æŸ˜æœ¨", "ç”²å¯…": "å¤§æºªæ°´", "ä¹™å¯": "å¤§æºªæ°´", "ä¸™è¾°": "æ²™ä¸­åœŸ", "ä¸å·³": "æ²™ä¸­åœŸ",
    "æˆŠåˆ": "å¤©ä¸Šç«", "å·±æœª": "å¤©ä¸Šç«", "åºšç”³": "çŸ³æ¦´æœ¨", "è¾›é…‰": "çŸ³æ¦´æœ¨", "å£¬æˆŒ": "å¤§æµ·æ°´", "ç™¸äº¥": "å¤§æµ·æ°´"
}

STEM_PROPS = {
    'ç”²': {'element': 'æœ¨', 'polarity': 'é™½'}, 'ä¹™': {'element': 'æœ¨', 'polarity': 'é™°'},
    'ä¸™': {'element': 'ç«', 'polarity': 'é™½'}, 'ä¸': {'element': 'ç«', 'polarity': 'é™°'},
    'æˆŠ': {'element': 'åœŸ', 'polarity': 'é™½'}, 'å·±': {'element': 'åœŸ', 'polarity': 'é™°'},
    'åºš': {'element': 'é‡‘', 'polarity': 'é™½'}, 'è¾›': {'element': 'é‡‘', 'polarity': 'é™°'},
    'å£¬': {'element': 'æ°´', 'polarity': 'é™½'}, 'ç™¸': {'element': 'æ°´', 'polarity': 'é™°'}
}

RELATION_MAP = {
    ('æœ¨', 'æœ¨'): 'åŒæˆ‘', ('æœ¨', 'ç«'): 'æˆ‘ç”Ÿ', ('æœ¨', 'åœŸ'): 'æˆ‘å‰‹', ('æœ¨', 'é‡‘'): 'å‰‹æˆ‘', ('æœ¨', 'æ°´'): 'ç”Ÿæˆ‘',
    ('ç«', 'ç«'): 'åŒæˆ‘', ('ç«', 'åœŸ'): 'æˆ‘ç”Ÿ', ('ç«', 'é‡‘'): 'æˆ‘å‰‹', ('ç«', 'æ°´'): 'å‰‹æˆ‘', ('ç«', 'æœ¨'): 'ç”Ÿæˆ‘',
    ('åœŸ', 'åœŸ'): 'åŒæˆ‘', ('åœŸ', 'é‡‘'): 'æˆ‘ç”Ÿ', ('åœŸ', 'æ°´'): 'æˆ‘å‰‹', ('åœŸ', 'æœ¨'): 'å‰‹æˆ‘', ('åœŸ', 'ç«'): 'ç”Ÿæˆ‘',
    ('é‡‘', 'é‡‘'): 'åŒæˆ‘', ('é‡‘', 'æ°´'): 'æˆ‘ç”Ÿ', ('é‡‘', 'æœ¨'): 'æˆ‘å‰‹', ('é‡‘', 'ç«'): 'å‰‹æˆ‘', ('é‡‘', 'åœŸ'): 'ç”Ÿæˆ‘',
    ('æ°´', 'æ°´'): 'åŒæˆ‘', ('æ°´', 'æœ¨'): 'æˆ‘ç”Ÿ', ('æ°´', 'ç«'): 'æˆ‘å‰‹', ('æ°´', 'åœŸ'): 'å‰‹æˆ‘', ('æ°´', 'é‡‘'): 'ç”Ÿæˆ‘',
}

@dataclass
class Bazi:
    year: str; month: str; day: str; hour: str
    def __post_init__(self):
        self.stems = [self.year[0], self.month[0], self.day[0], self.hour[0]]
        self.branches = [self.year[1], self.month[1], self.day[1], self.hour[1]]
        self.pillars = [self.year, self.month, self.day, self.hour]

# --- 2. é‚è¼¯é‹ç®—å‡½æ•¸ ---
def get_ten_god(me_stem, target_stem):
    if not me_stem or not target_stem: return ""
    me = STEM_PROPS[me_stem]; target = STEM_PROPS[target_stem]
    relation = RELATION_MAP[(me['element'], target['element'])]
    same_polarity = (me['polarity'] == target['polarity'])
    gods = {
        'åŒæˆ‘': {True: 'æ¯”è‚©', False: 'åŠ«è²¡'}, 'æˆ‘ç”Ÿ': {True: 'é£Ÿç¥', False: 'å‚·å®˜'},
        'æˆ‘å‰‹': {True: 'åè²¡', False: 'æ­£è²¡'}, 'å‰‹æˆ‘': {True: 'ä¸ƒæ®º', False: 'æ­£å®˜'},
        'ç”Ÿæˆ‘': {True: 'åå°', False: 'æ­£å°'}
    }
    return gods[relation][same_polarity]

def get_shen_sha_per_pillar(bazi, pillar_idx):
    day_stem = bazi.stems[2]     # æ—¥å¹²åŸºæº–
    year_stem = bazi.stems[0]    # å¹´å¹²åŸºæº– (æœ¬æ¬¡æ–°å¢ç¥ç…ä¹‹æ ¸å¿ƒ)
    
    branch = bazi.branches[pillar_idx]
    stem = bazi.stems[pillar_idx]
    pillar = bazi.pillars[pillar_idx]
    
    found = []

    # --- A. ä»¥æ—¥å¹²ç‚ºåŸºæº–çš„å‚³çµ±ç¥ç… (ä¿ç•™åŸæœ‰çš„) ---
    tian_yi_day = {'ç”²':['ä¸‘','æœª'], 'ä¹™':['å­','ç”³'], 'ä¸™':['äº¥','é…‰'], 'ä¸':['äº¥','é…‰'], 'æˆŠ':['ä¸‘','æœª'], 'å·±':['å­','ç”³'], 'åºš':['ä¸‘','æœª'], 'è¾›':['åˆ','å¯…'], 'å£¬':['å¯','å·³'], 'ç™¸':['å¯','å·³']}
    if branch in tian_yi_day.get(day_stem, []): found.append("å¤©ä¹™è²´äºº(æ—¥)")

    # --- B. ä»¥å¹´å¹²ç‚ºåŸºæº–çš„ç¥ç… (æ ¹æ“šæ‚¨çš„å°ç…§è¡¨æ–°å¢) ---
    me = year_stem # å®šç¾© me ç‚ºå¹´å¹²
    
    # 1. å¤©ä¹™
    tian_yi_year = {'ç”²':'å·³', 'ä¹™':'æœª', 'ä¸™':'ç”³', 'ä¸':'é…‰', 'æˆŠ':'äº¥', 'å·±':'ä¸‘', 'åºš':'å­', 'è¾›':'ä¸‘', 'å£¬':'å¯…', 'ç™¸':'å¯'}
    if branch == tian_yi_year.get(me): found.append("å¤©ä¹™")
    
    # 2. ç‰å ‚
    yu_tang_year = {'ç”²':'å¯', 'ä¹™':'ä¸‘', 'ä¸™':'å­', 'ä¸':'äº¥', 'æˆŠ':'é…‰', 'å·±':'æœª', 'åºš':'ç”³', 'è¾›':'æœª', 'å£¬':'åˆ', 'ç™¸':'å·³'}
    if branch == yu_tang_year.get(me): found.append("ç‰å ‚")
    
    # 3. æ–‡æ˜Œ
    wen_chang_year = {'ç”²':'å¯', 'ä¹™':'å·³', 'ä¸™':'åˆ', 'ä¸':'ç”³', 'æˆŠ':'é…‰', 'å·±':'ç”³', 'åºš':'é…‰', 'è¾›':'äº¥', 'å£¬':'å­', 'ç™¸':'å¯…'}
    if branch == wen_chang_year.get(me): found.append("æ–‡æ˜Œ")
    
    # 4. çœŸæ–‡æ˜Œ
    zhen_wen_chang = {'ç”²':'ä¹™å¯', 'ä¹™':'å·±å·³', 'ä¸™':'å£¬åˆ', 'ä¸':'ä¸™ç”³', 'æˆŠ':'å·±é…‰', 'å·±':'åºšç”³', 'åºš':'ç™¸é…‰', 'è¾›':'ä¸äº¥', 'å£¬':'åºšå­', 'ç™¸':'å£¬å¯…'}
    if pillar == zhen_wen_chang.get(me): found.append("çœŸæ–‡æ˜Œ")
    
    # 5. å…ƒç¥¿ç¥
    yuan_lu = {'ç”²':'å­', 'ä¹™':'å¯…', 'ä¸™':'å¯', 'ä¸':'å·³', 'æˆŠ':'åˆ', 'å·±':'å·³', 'åºš':'åˆ', 'è¾›':'ç”³', 'å£¬':'é…‰', 'ç™¸':'äº¥'}
    if branch == yuan_lu.get(me): found.append("å…ƒç¥¿ç¥")
    
    # 6. å…ƒæ˜Ÿ
    yuan_xing = {'ç”²':'ç”³', 'ä¹™':'å¯…', 'ä¸™':'äº¥', 'ä¸':'å¯', 'æˆŠ':'æˆŒ', 'å·±':'ä¸‘', 'åºš':'å­', 'è¾›':'è¾°', 'å£¬':'é…‰', 'ç™¸':'å·³'}
    if branch == yuan_xing.get(me): found.append("å…ƒæ˜Ÿ")
    
    # 7. å¤©å»š
    tian_chu = {'ç”²':'äº¥', 'ä¹™':'å·³', 'ä¸™':'åˆ', 'ä¸':'å­', 'æˆŠ':'å·³', 'å·±':'åˆ', 'åºš':'ç”³', 'è¾›':'å¯…', 'å£¬':'åˆ', 'ç™¸':'é…‰'}
    if branch == tian_chu.get(me): found.append("å¤©å»š")
    
    # 8. å¤ªæ¥µè²´äºº
    taiji = {'ç”²':['ç”³','å·³'], 'ä¹™':['å­','åˆ'], 'ä¸™':['å­','åˆ'], 'ä¸':['å¯','é…‰'], 'æˆŠ':['å¯','é…‰'], 'å·±':['è¾°','æˆŒ','ä¸‘','æœª'], 'åºš':['è¾°','æˆŒ','ä¸‘','æœª'], 'è¾›':['å¯…','äº¥'], 'å£¬':['å¯…','äº¥'], 'ç™¸':['ç”³','å·³']}
    if branch in taiji.get(me, []): found.append("å¤ªæ¥µè²´äºº")
    
    # 9. æ–‡æ˜Œè²´
    wen_chang_gui = {'ç”²':'ä¸‘', 'ä¹™':'å·³', 'ä¸™':'äº¥', 'ä¸':'æˆŒ', 'æˆŠ':'è¾°', 'å·±':'ç”³', 'åºš':'åˆ', 'è¾›':'å¯…', 'å£¬':'æœª', 'ç™¸':'å¯'}
    if branch == wen_chang_gui.get(me): found.append("æ–‡æ˜Œè²´")
    
    # 10. æ–‡æ˜Ÿè²´
    wen_xing_gui = {'ç”²':'å¯', 'ä¹™':'åˆ', 'ä¸™':'å·³', 'ä¸':'ç”³', 'æˆŠ':'é…‰', 'å·±':'ç”³', 'åºš':'é…‰', 'è¾›':'æˆŒ', 'å£¬':'äº¥', 'ç™¸':'å¯…'}
    if branch == wen_xing_gui.get(me): found.append("æ–‡æ˜Ÿè²´")
    
    # 11. å¤©å°è²´
    tian_yin_gui = {'ç”²':'å¯', 'ä¹™':'å¯…', 'ä¸™':'äº¥', 'ä¸':'æˆŒ', 'æˆŠ':'é…‰', 'å·±':'ç”³', 'åºš':'æœª', 'è¾›':'åˆ', 'å£¬':'å·³', 'ç™¸':'è¾°'}
    if branch == tian_yin_gui.get(me): found.append("å¤©å°è²´")
    
    # 12. å¤©ç¦
    tian_fu = {'ç”²':'å·³', 'ä¹™':'é…‰', 'ä¸™':'ç”³', 'ä¸':'å­', 'æˆŠ':'äº¥', 'å·±':'å¯', 'åºš':'å¯…', 'è¾›':'åˆ', 'å£¬':'å·³', 'ç™¸':'åˆ'}
    if branch == tian_fu.get(me): found.append("å¤©ç¦")
    
    # 13. å¤©å®˜
    tian_guan = {'ç”²':'åˆ', 'ä¹™':'æœª', 'ä¸™':'è¾°', 'ä¸':'å·³', 'æˆŠ':'å¯…', 'å·±':'å¯', 'åºš':'é…‰', 'è¾›':'äº¥', 'å£¬':'é…‰', 'ç™¸':'æˆŒ'}
    if branch == tian_guan.get(me): found.append("å¤©å®˜")
    
    # 14. æ­²å¾·
    sui_de = {'ç”²':'æˆŠ', 'ä¹™':'ç”²', 'ä¸™':'åºš', 'ä¸':'ä¸™', 'æˆŠ':'å£¬', 'å·±':'ç”²', 'åºš':'ç”²', 'è¾›':'åºš', 'å£¬':'ä¸™', 'ç™¸':'å£¬'}
    if stem == sui_de.get(me): found.append("æ­²å¾·")
    
    # 15. æ­²å¾·åˆ
    sui_de_he = {'ç”²':'ç™¸', 'ä¹™':'å·±', 'ä¸™':'ä¹™', 'ä¸':'è¾›', 'æˆŠ':'ä¸', 'å·±':'å·±', 'åºš':'å·±', 'è¾›':'ä¹™', 'å£¬':'è¾›', 'ç™¸':'ä¸'}
    if stem == sui_de_he.get(me): found.append("æ­²å¾·åˆ")
    
    # 16. æ­²å¹²åˆ
    sui_gan_he = {'ç”²':'æˆŠ', 'ä¹™':'å·±', 'ä¸™':'åºš', 'ä¸':'è¾›', 'æˆŠ':'å£¬', 'å·±':'ç™¸', 'åºš':'ç”²', 'è¾›':'ä¹™', 'å£¬':'ä¸™', 'ç™¸':'ä¸'}
    if stem == sui_gan_he.get(me): found.append("æ­²å¹²åˆ")
    
    # 17. çœŸé™½è²´
    zhen_yang_gui = {'ç”²':'ä¸å·³', 'ä¹™':'è¾›æœª', 'ä¸™':'ç”²ç”³', 'ä¸':'ä¸é…‰', 'æˆŠ':'è¾›äº¥', 'å·±':'ä¹™ä¸‘', 'åºš':'ä¸™å­', 'è¾›':'å·±ä¸‘', 'å£¬':'åºšå¯…', 'ç™¸':'ç™¸å¯'}
    if pillar == zhen_yang_gui.get(me): found.append("çœŸé™½è²´")
    
    # 18. çœŸé™°è²´
    zhen_yin_gui = {'ç”²':'ä¹™å¯', 'ä¹™':'ä¸ä¸‘', 'ä¸™':'æˆŠå­', 'ä¸':'ä¹™äº¥', 'æˆŠ':'å·±é…‰', 'å·±':'å·±æœª', 'åºš':'å£¬ç”³', 'è¾›':'ç™¸æœª', 'å£¬':'ç”²åˆ', 'ç™¸':'ä¹™å·³'}
    if pillar == zhen_yin_gui.get(me): found.append("çœŸé™°è²´")
    
    # 19. çœŸå‘½ç¥¿
    zhen_ming_lu = {'ç”²':'ç”²å­', 'ä¹™':'ä¸™å¯…', 'ä¸™':'å·±å¯', 'ä¸':'ç™¸å·³', 'æˆŠ':'ä¸™åˆ', 'å·±':'ä¸å·³', 'åºš':'åºšåˆ', 'è¾›':'ç”²ç”³', 'å£¬':'ä¸é…‰', 'ç™¸':'è¾›äº¥'}
    if pillar == zhen_ming_lu.get(me): found.append("çœŸå‘½ç¥¿")
    
    # 20. æ­¦æ›²æ˜Ÿ
    wu_qu = {'ç”²':'é…‰', 'ä¹™':'äº¥', 'ä¸™':'å­', 'ä¸':'å¯…', 'æˆŠ':'å¯', 'å·±':'å¯…', 'åºš':'å¯', 'è¾›':'å·³', 'å£¬':'è¾°', 'ç™¸':'ç”³'}
    if branch == wu_qu.get(me): found.append("æ­¦æ›²æ˜Ÿ")
    
    # 21. é‡‘ç¥ä¸ƒç…
    jin_shen_7_sha = {'ç”²':['ç”³','é…‰'], 'ä¹™':['æœª'], 'ä¸™':['è¾°','å·³'], 'ä¸':['å­','ä¸‘','å¯…','å¯'], 'æˆŠ':['æˆŒ','äº¥'], 'å·±':['ç”³','é…‰'], 'åºš':['åˆ','æœª'], 'è¾›':['è¾°','å·³'], 'å£¬':['å­','ä¸‘','å¯…','å¯'], 'ç™¸':['æˆŒ','äº¥']}
    if branch in jin_shen_7_sha.get(me, []): found.append("é‡‘ç¥ä¸ƒç…")
    
    # 22. ç´…è‰·ç…
    hong_yan_year = {'ç”²':'ç”³', 'ä¹™':'åˆ', 'ä¸™':'ç”³', 'ä¸':'å¯…', 'æˆŠ':'æœª', 'å·±':'è¾°', 'åºš':'è¾°', 'è¾›':'æˆŒ', 'å£¬':'é…‰', 'ç™¸':'å­'}
    if branch == hong_yan_year.get(me): found.append("ç´…è‰·ç…")
    
    # 23. æµéœ
    liu_xia_year = {'ç”²':'å¯…', 'ä¹™':'é…‰', 'ä¸™':'æˆŒ', 'ä¸':'æœª', 'æˆŠ':'ç”³', 'å·±':'å·³', 'åºš':'åˆ', 'è¾›':'è¾°', 'å£¬':'å¯', 'ç™¸':'äº¥'}
    if branch == liu_xia_year.get(me): found.append("æµéœ")
    
    # 24. å¤©æƒæ˜Ÿ
    tian_sao = {'ç”²':'ç”²æˆŒ', 'ä¹™':'ç™¸æœª', 'ä¸™':'å£¬åˆ', 'ä¸':'è¾›å·³', 'æˆŠ':'åºšè¾°', 'å·±':'å¯', 'åºš':'æˆŠå¯…', 'è¾›':'ä¸ä¸‘', 'å£¬':'ä¸™å­', 'ç™¸':'ä¹™äº¥'}
    if pillar == tian_sao.get(me): found.append("å¤©æƒæ˜Ÿ")
    
    # 25. ç¯€åº¦è²´äºº
    jie_du = {'ç”²':'ä¸‘', 'ä¹™':'å·³', 'ä¸™':'æœª', 'ä¸':'å·³', 'æˆŠ':'æœª', 'å·±':'å·³', 'åºš':'æœª', 'è¾›':'äº¥', 'å£¬':'ä¸‘', 'ç™¸':'äº¥'}
    if branch == jie_du.get(me): found.append("ç¯€åº¦è²´äºº")
    
    # 26. é‡‘è¼¿
    jin_yu_year = {'ç”²':'å¯…', 'ä¹™':'è¾°', 'ä¸™':'å·³', 'ä¸':'æœª', 'æˆŠ':'ç”³', 'å·±':'æœª', 'åºš':'ç”³', 'è¾›':'æˆŒ', 'å£¬':'äº¥', 'ç™¸':'ä¸‘'}
    if branch == jin_yu_year.get(me): found.append("é‡‘è¼¿")
    
    # 27. ç¦æ˜Ÿè²´äºº
    fu_xing_year = {'ç”²':['ä¹™å¯','ä¹™ä¸‘'], 'ä¹™':['ä¸™å¯…','ä¸™å­'], 'ä¸™':['ä¸äº¥','ä¸ä¸‘'], 'ä¸':['æˆŠæˆŒ'], 'æˆŠ':['å·±é…‰'], 'å·±':['åºšç”³'], 'åºš':['è¾›æœª'], 'è¾›':['å£¬è¾°'], 'å£¬':['ç™¸å·³'], 'ç™¸':['ç”²è¾°']}
    if pillar in fu_xing_year.get(me, []): found.append("ç¦æ˜Ÿè²´äºº")

    return found

# --- 3. æ¸²æŸ“å°ˆæ¥­å‘½ç›¤ ---
def render_professional_chart(bazi):
    me_stem = bazi.stems[2] # æ—¥ä¸»
    pillar_data = [
        {"title": "å¹´æŸ±", "p": bazi.year, "s": bazi.stems[0], "b": bazi.branches[0], "note": "ç¥–è¼©ç«¥å¹´", "idx": 0},
        {"title": "æœˆæŸ±", "p": bazi.month,"s": bazi.stems[1], "b": bazi.branches[1], "note": "çˆ¶æ¯é’å¹´", "idx": 1},
        {"title": "æ—¥æŸ±", "p": bazi.day,  "s": bazi.stems[2], "b": bazi.branches[2], "note": "è‡ªèº«é…å¶", "idx": 2},
        {"title": "æ™‚æŸ±", "p": bazi.hour, "s": bazi.stems[3], "b": bazi.branches[3], "note": "å­å¥³æ™šå¹´", "idx": 3}
    ]

    results = []
    for p in pillar_data:
        hidden_data = HIDDEN_STEMS_DATA.get(p["b"], [])
        results.append({
            "title": p["title"],
            "ten_god": get_ten_god(me_stem, p["s"]) if p["title"] != "æ—¥æŸ±" else "æ—¥ä¸»",
            "stem": p["s"],
            "branch": p["b"],
            "life_stage": LIFE_STAGES[me_stem][p["b"]],
            "nayin": NAYIN_DATA.get(p["p"], ""),
            "hidden_info": [{"stem": s, "weight": w, "god": get_ten_god(me_stem, s)} for s, w in hidden_data],
            "shen_sha": get_shen_sha_per_pillar(bazi, p["idx"]),
            "note": p["note"]
        })

    base_font = "'DFKai-SB', 'BiauKai', 'æ¨™æ¥·é«”', serif"
    l_fs = "20px"; c_fs = "18px"
    
    html = f"""
    <div style="overflow-x: auto; margin: 20px 0; font-family: {base_font}; text-align: center;">
        <table style="width:100%; border-collapse: collapse; text-align: center; border: 2.5px solid #333;">
            <tr style="background-color: #f1f1f1; font-weight: bold; font-size: {l_fs};">
                <td style="width: 140px; background: #eee; border: 1px solid #ddd; padding: 12px;">ä½ç½®</td>
                {"".join([f'<td style="border: 1px solid #ddd; {"background:#fff5f5;" if r["title"]=="æ—¥æŸ±" else ""}">{r["title"]}</td>' for r in results])}
            </tr>
            <tr style="font-size: {l_fs}; color: #d35400; font-weight: bold;">
                <td style="background: #eee; border: 1px solid #ddd; padding: 12px; color: #333;">å®®ä½æ„æ¶µ</td>
                {"".join([f'<td style="border: 1px solid #ddd; background: #fffcf5;">{r["note"]}</td>' for r in results])}
            </tr>
            <tr style="font-size: {c_fs};">
                <td style="background: #eee; border: 1px solid #ddd; padding: 12px; font-weight: bold; font-size: {l_fs};">åç¥</td>
                {"".join([f'<td style="border: 1px solid #ddd; {"color:#d63031;font-weight:bold;" if r["title"]=="æ—¥æŸ±" else ""}">{r["ten_god"]}</td>' for r in results])}
            </tr>
            <tr style="font-size: 36px; font-weight: bold;">
                <td style="background: #eee; border: 1px solid #ddd; padding: 15px; font-size: {l_fs};">å¤©å¹²</td>
                {"".join([f'<td style="border: 1px solid #ddd; {"color:#d63031;" if r["title"]=="æ—¥æŸ±" else ""}">{r["stem"]}</td>' for r in results])}
            </tr>
            <tr style="font-size: 36px; font-weight: bold;">
                <td style="background: #eee; border: 1px solid #ddd; padding: 15px; font-size: {l_fs};">åœ°æ”¯</td>
                {"".join([f'<td style="border: 1px solid #ddd;">{r["branch"]}</td>' for r in results])}
            </tr>
            <tr>
                <td style="background: #eee; border: 1px solid #ddd; padding: 10px; font-weight: bold; font-size: {l_fs};">è—å¹²åç¥æ¯”ä¾‹</td>
                {"".join([f'''<td style="border: 1px solid #ddd; font-size: {c_fs}; vertical-align: middle;">
                    <div style="display: inline-block; text-align: center; width: 100%;">
                        {"".join([f'<div>{h["stem"]}({h["god"]}) {h["weight"]}%</div>' for h in r["hidden_info"]])}
                    </div>
                </td>''' for r in results])}
            </tr>
            <tr style="color: #2980b9; font-weight: bold; font-size: {c_fs};">
                <td style="background: #eee; border: 1px solid #ddd; padding: 10px; font-weight: bold; font-size: {l_fs}; color: #333;">åäºŒé‹æ˜Ÿ</td>
                {"".join([f'<td style="border: 1px solid #ddd;">{r["life_stage"]}</td>' for r in results])}
            </tr>
            <tr style="color: #8e44ad; font-weight: bold; font-size: {c_fs};">
                <td style="background: #eee; border: 1px solid #ddd; padding: 10px; font-weight: bold; font-size: {l_fs}; color: #333;">ç¥ç…ç³»çµ±</td>
                {"".join([f'<td style="border: 1px solid #ccc;">{"<br>".join(r["shen_sha"]) if r["shen_sha"] else "â€”"}</td>' for r in results])}
            </tr>
            <tr style="font-size: {c_fs}; color: #666;">
                <td style="background: #eee; border: 1px solid #ddd; padding: 10px; font-weight: bold; font-size: {l_fs}; color: #333;">ç´éŸ³</td>
                {"".join([f'<td style="border: 1px solid #ddd;">{r["nayin"]}</td>' for r in results])}
            </tr>
        </table>
    </div>
    """
    return html

# --- 4. Streamlit ä»‹é¢ ---
st.set_page_config(page_title="å°ˆæ¥­ AI å…«å­—ç³»çµ±", layout="wide")
st.title("ğŸ”® å°ˆæ¥­ AI å…«å­—å…¨æ–¹ä½è§£æç³»çµ±")

input_text = st.text_input("è¼¸å…¥å…«å­—ï¼ˆä¾‹ï¼šä¹™å·³ æˆŠå¯… è¾›äº¥ å£¬è¾°ï¼‰", "ä¹™å·³ æˆŠå¯… è¾›äº¥ å£¬è¾°")

if input_text:
    matches = re.findall(r'[ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥]', input_text)
    if len(matches) >= 4:
        bazi = Bazi(matches[0], matches[1], matches[2], matches[3])
        st.markdown(render_professional_chart(bazi), unsafe_allow_html=True)
        
        # èƒ½é‡åˆ†å¸ƒé›·é”åœ–
        st.divider()
        scores = {"æœ¨": 0, "ç«": 0, "åœŸ": 0, "é‡‘": 0, "æ°´": 0}
        for s in bazi.stems: scores[ELEMENTS_MAP[s]] += 1.0
        for b in bazi.branches:
            for s, w in HIDDEN_STEMS_DATA[b]:
                scores[ELEMENTS_MAP[s]] += (w/100.0)
        
        fig = go.Figure(go.Scatterpolar(r=list(scores.values())+[list(scores.values())[0]], theta=list(scores.keys())+[list(scores.keys())[0]], fill='toself'))
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.error("æ ¼å¼éŒ¯èª¤ï¼šè«‹ç¢ºä¿è¼¸å…¥å››çµ„å®Œæ•´çš„å¹²æ”¯ã€‚")
