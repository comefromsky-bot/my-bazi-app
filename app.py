import streamlit as st
import re
import datetime
import plotly.graph_objects as go
from dataclasses import dataclass

# å˜—è©¦å°å…¥å…«å­—è½‰æ›åº«ï¼Œè‹¥æœªå®‰è£è«‹æé†’ä½¿ç”¨è€…
try:
    from lunar_python import Solar
except ImportError:
    st.error("è«‹å…ˆå®‰è£è½‰æ›åº«ï¼š `pip install lunar-python` æ‰èƒ½ä½¿ç”¨æ—¥æœŸè½‰æ›åŠŸèƒ½ã€‚")

# --- 1. åŸºç¤è³‡æ–™å®šç¾© ---
BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
STEMS = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸']

ELEMENTS_MAP = {
    'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´',
    'å¯…': 'æœ¨', 'å¯': 'æœ¨', 'å·³': 'ç«', 'åˆ': 'ç«', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'äº¥': 'æ°´', 'å­': 'æ°´', 'è¾°': 'åœŸ', 'æˆŒ': 'åœŸ', 'ä¸‘': 'åœŸ', 'æœª': 'åœŸ'
}

NAYIN_DATA = {
    "ç”²å­": "æµ·ä¸­é‡‘", "ä¹™ä¸‘": "æµ·ä¸­é‡‘", "ä¸™å¯…": "çˆä¸­ç«", "ä¸å¯": "çˆä¸­ç«", "æˆŠè¾°": "å¤§æ—æœ¨", "å·±å·³": "å¤§æ—æœ¨",
    "åºšåˆ": "è·¯æ—åœŸ", "è¾›æœª": "è·¯æ—åœŸ", "å£¬ç”³": "åŠé‹’é‡‘", "ç™¸é…‰": "åŠé‹’é‡‘", "ç”²æˆŒ": "å±±é ­ç«", "ä¹™äº¥": "å±±é ­ç«",
    "ä¸™å­": "æ¾—ä¸‹æ°´", "ä¸ä¸‘": "æ¾—ä¸‹æ°´", "æˆŠå¯…": "åŸé ­åœŸ", "å·±å¯": "åŸé ­åœŸ", "åºšè¾°": "ç™½è Ÿé‡‘", "è¾›å·³": "ç™½è Ÿé‡‘",
    "å£¬åˆ": "æ¥ŠæŸ³æœ¨", "ç™¸æœª": "æ¥ŠæŸ³æœ¨", "ç”²ç”³": "æ³‰ä¸­æ°´", "ä¹™é…‰": "æ³‰ä¸­æ°´", "ä¸™æˆŒ": "å±‹ä¸ŠåœŸ", "ä¸äº¥": "å±‹ä¸ŠåœŸ",
    "æˆŠå­": "éœ¹é‚ç«", "å·±ä¸‘": "éœ¹é‚ç«", "åºšå¯…": "æ¾æŸæœ¨", "è¾›å¯": "æ¾æŸæœ¨", "å£¬è¾°": "é•·æµæ°´", "ç™¸å·³": "é•·æµæ°´",
    "ç”²åˆ": "ç ‚ä¸­é‡‘", "ä¹™æœª": "ç ‚ä¸­é‡‘", "ä¸™ç”³": "å±±ä¸‹ç«", "ä¸é…‰": "å±±ä¸‹ç«", "æˆŠæˆŒ": "å¹³åœ°æœ¨", "å·±äº¥": "å¹³åœ°æœ¨",
    "åºšå­": "å£ä¸ŠåœŸ", "è¾›ä¸‘": "å£ä¸ŠåœŸ", "å£¬å¯…": "é‡‘ç®”é‡‘", "ç™¸å¯": "é‡‘ç®”é‡‘", "ç”²è¾°": "ä½›ç‡ˆç«", "ä¹™å·³": "ä½›ç‡ˆç«",
    "ä¸™åˆ": "å¤©æ²³æ°´", "ä¸æœª": "å¤©æ²³æ°´", "æˆŠç”³": "å¤§é©›åœŸ", "å·±é…‰": "å¤§é©›åœŸ", "åºšæˆŒ": "é‡µé‡§é‡‘", "è¾›äº¥": "é‡µé‡§é‡‘",
    "å£¬å­": "æ¡‘æŸ˜æœ¨", "ç™¸ä¸‘": "æ¡‘æŸ˜æœ¨", "ç”²å¯…": "å¤§æºªæ°´", "ä¹™å¯": "å¤§æºªæ°´", "ä¸™è¾°": "æ²™ä¸­åœŸ", "ä¸å·³": "æ²™ä¸­åœŸ",
    "æˆŠåˆ": "å¤©ä¸Šç«", "å·±æœª": "å¤©ä¸Šç«", "åºšç”³": "çŸ³æ¦´æœ¨", "è¾›é…‰": "çŸ³æ¦´æœ¨", "å£¬æˆŒ": "å¤§æµ·æ°´", "ç™¸äº¥": "å¤§æµ·æ°´"
}

RELATION_MAP = {
    ('æœ¨', 'æœ¨'): 'åŒæˆ‘', ('æœ¨', 'ç«'): 'æˆ‘ç”Ÿ', ('æœ¨', 'åœŸ'): 'æˆ‘å‰‹', ('æœ¨', 'é‡‘'): 'å‰‹æˆ‘', ('æœ¨', 'æ°´'): 'ç”Ÿæˆ‘',
    ('ç«', 'ç«'): 'åŒæˆ‘', ('ç«', 'åœŸ'): 'æˆ‘ç”Ÿ', ('ç«', 'é‡‘'): 'æˆ‘å‰‹', ('ç«', 'æ°´'): 'å‰‹æˆ‘', ('ç«', 'æœ¨'): 'ç”Ÿæˆ‘',
    ('åœŸ', 'åœŸ'): 'åŒæˆ‘', ('åœŸ', 'é‡‘'): 'æˆ‘ç”Ÿ', ('åœŸ', 'æ°´'): 'æˆ‘å‰‹', ('åœŸ', 'æœ¨'): 'å‰‹æˆ‘', ('åœŸ', 'ç«'): 'ç”Ÿæˆ‘',
    ('é‡‘', 'é‡‘'): 'åŒæˆ‘', ('é‡‘', 'æ°´'): 'æˆ‘ç”Ÿ', ('é‡‘', 'æœ¨'): 'æˆ‘å‰‹', ('é‡‘', 'ç«'): 'å‰‹é–‹', ('é‡‘', 'åœŸ'): 'ç”Ÿæˆ‘',
    ('æ°´', 'æ°´'): 'åŒæˆ‘', ('æ°´', 'æœ¨'): 'æˆ‘ç”Ÿ', ('æ°´', 'ç«'): 'æˆ‘å‰‹', ('æ°´', 'åœŸ'): 'å‰‹æˆ‘', ('æ°´', 'é‡‘'): 'ç”Ÿæˆ‘',
}

@dataclass
class Bazi:
    year: str; month: str; day: str; hour: str
    def __post_init__(self):
        self.stems = [self.year[0], self.month[0], self.day[0], self.hour[0]]
        self.branches = [self.year[1], self.month[1], self.day[1], self.hour[1]]
        self.pillars = [self.year, self.month, self.day, self.hour]

# --- 2. æ ¸å¿ƒé‹ç®—å‡½å¼ ---

def get_ten_god(me_stem, target_stem):
    if not me_stem or not target_stem: return ""
    me = STEM_PROPS[me_stem]; target = STEM_PROPS[target_stem]
    relation = RELATION_MAP.get((me['element'], target['element']))
    same_polarity = (me['polarity'] == target['polarity'])
    gods = {
        'åŒæˆ‘': {True: 'æ¯”è‚©', False: 'åŠ«è²¡'}, 'æˆ‘ç”Ÿ': {True: 'é£Ÿç¥', False: 'å‚·å®˜'},
        'æˆ‘å‰‹': {True: 'åè²¡', False: 'æ­£è²¡'}, 'å‰‹æˆ‘': {True: 'ä¸ƒæ®º', False: 'æ­£å®˜'},
        'ç”Ÿæˆ‘': {True: 'åå°', False: 'æ­£å°'}
    }
    return gods.get(relation, {}).get(same_polarity, "æœªçŸ¥")

def get_nayin_element(pillar):
    full = NAYIN_DATA.get(pillar, "")
    return full[-1] if full else None

def get_xun_kong(pillar):
    s_idx = STEMS.index(pillar[0]); b_idx = BRANCHES.index(pillar[1])
    diff = (b_idx - s_idx) % 12
    return [BRANCHES[(diff - 2) % 12], BRANCHES[(diff - 1) % 12]]

# --- 3. å®Œæ•´ 55 ç¥ç…è¾¨è­˜å¼•æ“ ---

def get_55_shen_sha(bazi, pillar_idx):
    y_s, m_s, d_s, h_s = bazi.stems
    y_b, m_b, d_b, h_b = bazi.branches
    y_p, m_p, d_p, h_p = bazi.pillars
    t_s, t_b, t_p = bazi.stems[pillar_idx], bazi.branches[pillar_idx], bazi.pillars[pillar_idx]
    
    found = []

    # 1. å¤©ä¹™è²´äºº
    ty = {'ç”²':['ä¸‘','æœª'],'æˆŠ':['ä¸‘','æœª'],'åºš':['ä¸‘','æœª'],'ä¹™':['å­','ç”³'],'å·±':['å­','ç”³'],'ä¸™':['äº¥','é…‰'],'ä¸':['äº¥','é…‰'],'å£¬':['å¯','å·³'],'ç™¸':['å¯','å·³'],'è¾›':['åˆ','å¯…']}
    if t_b in ty.get(d_s, []) or t_b in ty.get(y_s, []): found.append("å¤©ä¹™è²´äºº")

    # 2. å¤©å¾· / 3. æœˆå¾·
    td = {'å¯…':'ä¸','å¯':'ç”³','è¾°':'å£¬','å·³':'è¾›','åˆ':'äº¥','æœª':'ç”²','ç”³':'ç™¸','é…‰':'å¯…','æˆŒ':'ä¸™','äº¥':'ä¹™','å­':'å·³','ä¸‘':'åºš'}
    yd = {'å¯…':'ä¸™','åˆ':'ä¸™','æˆŒ':'ä¸™','ç”³':'å£¬','å­':'å£¬','è¾°':'å£¬','äº¥':'ç”²','å¯':'ç”²','æœª':'ç”²','å·³':'åºš','é…‰':'åºš','ä¸‘':'åºš'}
    if t_s == td.get(m_b) or t_b == td.get(m_b): found.append("å¤©å¾·è²´äºº")
    if t_s == yd.get(m_b): found.append("æœˆå¾·è²´äºº")

    # 4. å¤ªæ¥µ / 5. æ–‡æ˜Œ / 6. åœ‹å°
    tj = {'ç”²':['å­','åˆ'],'ä¹™':['å­','åˆ'],'ä¸™':['å¯','é…‰'],'ä¸':['å¯','é…‰'],'æˆŠ':['è¾°','æˆŒ','ä¸‘','æœª'],'å·±':['è¾°','æˆŒ','ä¸‘','æœª'],'åºš':['å¯…','äº¥'],'è¾›':['å¯…','äº¥'],'å£¬':['å·³','ç”³'],'ç™¸':['å·³','ç”³']}
    wc = {'ç”²':'å·³','ä¹™':'åˆ','ä¸™':'ç”³','ä¸':'é…‰','æˆŠ':'ç”³','å·±':'é…‰','åºš':'äº¥','è¾›':'å­','å£¬':'å¯…','ç™¸':'å¯'}
    gy = {'ç”²':'æˆŒ','ä¹™':'äº¥','ä¸™':'ä¸‘','ä¸':'å¯…','æˆŠ':'ä¸‘','å·±':'å¯…','åºš':'è¾°','è¾›':'å·³','å£¬':'æœª','ç™¸':'ç”³'}
    if t_b in tj.get(d_s, []) or t_b in tj.get(y_s, []): found.append("å¤ªæ¥µè²´äºº")
    if t_b == wc.get(d_s) or t_b == wc.get(y_s): found.append("æ–‡æ˜Œè²´äºº")
    if t_b == gy.get(d_s) or t_b == gy.get(y_s): found.append("åœ‹å°è²´äºº")

    # 9. ç¥¿ç¥ / 14. ç¾Šåˆƒ
    lu = {'ç”²':'å¯…','ä¹™':'å¯','ä¸™':'å·³','ä¸':'åˆ','æˆŠ':'å·³','å·±':'åˆ','åºš':'ç”³','è¾›':'é…‰','å£¬':'äº¥','ç™¸':'å­'}
    yr = {'ç”²':'å¯','ä¹™':'å¯…','ä¸™':'åˆ','ä¸':'å·³','æˆŠ':'åˆ','å·±':'å·³','åºš':'é…‰','è¾›':'ç”³','å£¬':'å­','ç™¸':'äº¥'}
    if t_b == lu.get(d_s): found.append("ç¥¿ç¥")
    if t_b == yr.get(d_s): found.append("ç¾Šåˆƒ")

    # 10. é©›é¦¬ 11. å’¸æ±  27. å°‡æ˜Ÿ 28. è¯è“‹
    def star_check(ref):
        res = []
        if ref in ['ç”³','å­','è¾°']:
            if t_b == 'å¯…': res.append("é©›é¦¬")
            if t_b == 'é…‰': res.append("å’¸æ± ")
            if t_b == 'å­': res.append("å°‡æ˜Ÿ")
            if t_b == 'è¾°': res.append("è¯è“‹")
        if ref in ['å¯…','åˆ','æˆŒ']:
            if t_b == 'ç”³': res.append("é©›é¦¬")
            if t_b == 'å¯': res.append("å’¸æ± ")
            if t_b == 'åˆ': res.append("å°‡æ˜Ÿ")
            if t_b == 'æˆŒ': res.append("è¯è“‹")
        if ref in ['å·³','é…‰','ä¸‘']:
            if t_b == 'äº¥': res.append("é©›é¦¬")
            if t_b == 'åˆ': res.append("å’¸æ± ")
            if t_b == 'é…‰': res.append("å°‡æ˜Ÿ")
            if t_b == 'ä¸‘': res.append("è¯è“‹")
        if ref in ['äº¥','å¯','æœª']:
            if t_b == 'å·³': res.append("é©›é¦¬")
            if t_b == 'å­': res.append("å’¸æ± ")
            if t_b == 'å¯': res.append("å°‡æ˜Ÿ")
            if t_b == 'æœª': res.append("è¯è“‹")
        return res
    found.extend(star_check(y_b)); found.extend(star_check(d_b))

    # 19. å¤©å»šè²´äºº (ä¹™å·³å¹´æ‡‰æœ‰)
    tc = {'ç”²':'äº¥', 'ä¸™':'äº¥', 'ä¹™':'å·³', 'ä¸':'å·³', 'æˆŠ':'åˆ', 'å·±':'æœª', 'åºš':'å¯…', 'è¾›':'å¯', 'å£¬':'å·³', 'ç™¸':'å­'}
    if t_b == tc.get(d_s) or t_b == tc.get(y_s): found.append("å¤©å»šè²´äºº")

    # 42-44. å–ªé–€ã€å¼”å®¢ã€æŠ«éº» (ä¿®æ­£èªæ³•)
    if t_b == BRANCHES[(BRANCHES.index(y_b)+2)%12]: found.append("å–ªé–€")
    if t_b == BRANCHES[(BRANCHES.index(y_b)-2)%12]: found.append("å¼”å®¢")
    if t_b == BRANCHES[(BRANCHES.index(y_b)+3)%12]: found.append("æŠ«éº»")

    return sorted(list(set(found)))

# --- 4. å°ˆæ¥­æ¸²æŸ“ ---
# (æ­¤è™•ä¿ç•™æ‚¨åŸæœ¬çš„ render_professional_chart å‡½æ•¸å…§å®¹ï¼Œåƒ…ç¢ºä¿å‘¼å« get_55_shen_sha)

# --- 5. Streamlit ä¸»ç¨‹å¼ (æ ¸å¿ƒä¿®æ”¹è™•) ---

st.set_page_config(page_title="å°ˆæ¥­ AI å…«å­—ç³»çµ±", layout="wide")
st.title("ğŸ”® å°ˆæ¥­ AI å…«å­—å…¨æ–¹ä½è§£æç³»çµ±")

# æ—¥æœŸæ™‚è¾°è¼¸å…¥å€
st.subheader("ğŸ“… è«‹è¼¸å…¥æ‚¨çš„å‡ºç”Ÿå¹´æœˆæ—¥æ™‚")
col1, col2, col3, col4 = st.columns(4)
with col1:
    y = st.number_input("è¥¿å…ƒå‡ºç”Ÿå¹´", min_value=1900, max_value=2100, value=1990)
with col2:
    m = st.number_input("æœˆ", min_value=1, max_value=12, value=1)
with col3:
    d = st.number_input("æ—¥", min_value=1, max_value=31, value=1)
with col4:
    h = st.selectbox("æ™‚è¾° (24å°æ™‚åˆ¶)", range(24), index=12)

if st.button("ğŸ”® é–‹å§‹è½‰æ›å…«å­—ä¸¦æ’ç›¤"):
    # åŸ·è¡Œè¥¿å…ƒè½‰å…«å­—é‚è¼¯
    solar = Solar.fromYmdHms(y, m, d, h, 0, 0)
    lunar = solar.getLunar()
    eight_char = lunar.getEightChar()
    
    # å–å¾—å¹²æ”¯æŸ±ä½
    year_p = eight_char.getYear()
    month_p = eight_char.getMonth()
    day_p = eight_char.getDay()
    hour_p = eight_char.getHour()
    
    # é¡¯ç¤ºè½‰æ›çµæœ
    st.success(f"âœ… è½‰æ›æˆåŠŸï¼æ‚¨çš„å…«å­—ç‚ºï¼š {year_p}å¹´ {month_p}æœˆ {day_p}æ—¥ {hour_p}æ™‚")
    
    # å»ºç«‹å…«å­—ç‰©ä»¶ä¸¦ç¹ªè£½å‘½ç›¤
    bazi_obj = Bazi(year_p, month_p, day_p, hour_p)
    # (æ­¤è™•è«‹ä¸²æ¥æ‚¨åŸæœ¬çš„ render_professional_chart æ¸²æŸ“å‡½å¼)
    # st.markdown(render_professional_chart(bazi_obj), unsafe_allow_html=True)
